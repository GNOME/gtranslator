#! /usr/bin/make -f
# This is not a -*- Makefile -*- I'm just faking it
# *sigh*

checkdir=test -f debian/control 
checkroot=test `id -u` -eq 0

configure: configure-stamp
configure-stamp:
	$(checkdir)
	/bin/sh ./configure --disable-debug		\
		--prefix=/usr 				\
		--mandir=\$${prefix}/share/man
	touch configure-stamp

build: configure build-stamp
build-stamp:
	$(checkdir)
	$(MAKE)
	touch build-stamp

install: install-stamp
install-stamp:
	$(checkdir)
	$(checkroot)

	$(MAKE) install \
		prefix=`pwd`/debian/tmp/usr \
		sysconfdir=`pwd`/debian/tmp/etc \
		SC_OMFDIR=`pwd`/debian/tmp/usr/share/omf

	find debian/tmp -type d -print0 | xargs -0 chmod 755
	strip -R .note -R .comment debian/tmp/usr/bin/gtranslator
	touch install-stamp

clean:
	$(checkdir)
	$(checkroot)

	-$(MAKE) distclean
	-rm -rf build-stamp configure-stamp install-stamp intltool-extract intltool-merge intltool-update
	-rm -rf debian/tmp
	-rm -rf debian/files debian/substvars

binary-arch: build install
	$(checkdir)
	$(checkroot)

	# Install stuff	
	install -d -m 755 -o root -g root debian/tmp/DEBIAN
	install -d -m 755 -o root -g root debian/tmp/usr/lib/menu
	install -d -m 755 -o root -g root debian/tmp/usr/share/doc/gtranslator

	install -m 644 -o root -g root README			\
		debian/tmp/usr/share/doc/gtranslator/README
	install -m 644 -o root -g root 			\
		debian/tmp/usr/share/doc/gtranslator/NEWS
	install -m 644 -o root -g root 			\
		debian/tmp/usr/share/doc/gtranslator/AUTHORS
	install -m 644 -o root -g root 			\
		debian/tmp/usr/share/doc/gtranslator/THANKS
	install -m 644 -o root -g root 			\
		debian/tmp/usr/share/doc/gtranslator/TODO

	install -m 644 -o root -g root ChangeLog		\
		debian/tmp/usr/share/doc/gtranslator/changelog

	install -m 644 -o root -g root debian/copyright		\
		debian/tmp/usr/share/doc/gtranslator
	install -m 644 -o root -g root debian/changelog		\
		debian/tmp/usr/share/doc/gtranslator/changelog.Debian

	install -m 644 -o root -g root debian/menu		\
		debian/tmp/usr/lib/menu/gtranslator

	install -m 755 -o root -g root debian/postinst		\
		debian/tmp/DEBIAN/postinst
	install -m 755 -o root -g root debian/postrm		\
		debian/tmp/DEBIAN/postrm

	gzip -9f debian/tmp/usr/share/doc/gtranslator/README
	gzip -9f debian/tmp/usr/share/doc/gtranslator/NEWS
	gzip -9f debian/tmp/usr/share/doc/gtranslator/changelog
	gzip -9f debian/tmp/usr/share/doc/gtranslator/changelog.Debian

	dpkg-shlibdeps -Tdebian/substvars			\
		debian/tmp/usr/bin/gtranslator
	dpkg-gencontrol -pgtranslator -isp -Pdebian/tmp -Tdebian/substvars
	dpkg --build debian/tmp ..

binary:	binary-arch

.PHONY: configure build binary-indep binary-arch binary clean
